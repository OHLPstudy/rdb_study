
## ë‚˜ì—ê²Œ ë„ì›€ì´ ë˜ëŠ” Tip

- ì»¬ëŸ¼ ê°’ì— ë”°ë¥¸ íŠ¹ì • ê°’ì´ í•„ìš”í•œ ì¼€ì´ìŠ¤

ì„±ë³„ì´ ì—¬ì„±ì¸ ê²½ìš°ì—ë§Œ ê¸‰ì—¬ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```sql
SELECT de.dept_ná„‹, e.first_name, e.gender,
CASE WHEN e.gender='F' THEN
(SELECT s.salary FROM salaries s
WHERE s .emp_no=e.emp_no
ORDER BY from.date DESC LIMIT 1)
ELSE 0 END AS last.salary
FROM dept_emp de, employees e
WHERE e .emp_no=de.emp_no
AND deâ€¢dept_no='d001'ï¼›
```

- ë‚¨ì„±ì¸ ê²½ìš°ëŠ” ì„œë¸Œì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šì•„ ë¶ˆí•„ìš”í•œ ì„œë¸Œì¿¼ë¦¬ ìˆ˜í–‰ì„ ë°©ì§€

### Select ì¿¼ë¦¬ ìˆ˜í–‰ ìˆœì„œ

![image.png](attachment:51f3e1ea-0ea3-4bcb-8213-2e55fc843b24:image.png)

- ê·¸ë˜ì„œ Limit ì˜µì…˜ì´ ì¶”ê°€ ëœë‹¤ê³ í•´ì„œ ê²€ìƒ‰í•˜ëŠ” í…Œì´ë¸” ë°ì´í„°ì˜ ìˆ˜ê°€ ë‹¬ë¼ì§€ì§€ ì•Šì•˜ë‚˜ë³´ì˜¤.

### Limit ì‚¬ìš©ì— ëŒ€í•œ Tip

```sql
mysqlã€‰ SELECT * FROM salaries ORDER BY salary LIMIT 0,10;
10 rows in set (0.00 sec)
mysql) SELECT * FROM salaries ORDER BY salary LIMIT 2000000,10;
10 rows in set (1.57 sec)
```

í™”ë©´ì— ë³´ì—¬ì§ˆ 10ê±´ì„ ì¡°íšŒí•˜ê¸° ìœ„í•´ 2000000ê±´ì˜ ë ˆì½”ë“œë¥¼ ì½ì€ í›„ ë§ˆì§€ë§‰ 10ê±´ë§Œ ë°˜í™˜ë˜ì–´ì•¼ í•¨

- í…Œì´ë¸” í’€ìŠ¤ìº”ê³¼ ë‹¤ë¥¼ ë°”ê°€ ì—†ì–´ì§.

```sql
- II ë‘ ë²ˆì§¸ í˜ì´ì§€ ì¡°íšŒìš© ì¿¼ë¦¬(ì²« í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ salary ê°’ê³¼ emp.no ê°’ì„ ì´ìš©)
mysqlã€‰ SELECT * FROM salaries
WHERE salary>=38864 AND NOT (salary=38864 AND emp_no<=274049)
ORDER BY salary LIMIT 0, 10ï¼›
```

- ì´ì „ ì¿¼ë¦¬ì˜ ë§ˆì§€ë§‰ salary, emp_noì„ ê°€ì§€ê³  ì˜¬ ìˆ˜ ìˆë‹¤ë©´ ì¿¼ë¦¬ ì‹œê°„ì„  ë‹¨ì¶• ì‹œí‚¬ ìˆ˜ ìˆìŒ

### í˜ì´ì§•ì²˜ë¦¬ë¥¼ ìœ„í•œ Count ì¿¼ë¦¬ ì‘ì„± ì‹œ ì¡°ì‹¬í•´ì•¼í•  ì 

```sql
COUNT(*) ì¿¼ë¦¬ì—ì„œ ê°€ì¥ ë§ì´ í•˜ëŠ” ì‹¤ìˆ˜ëŠ” ORDER BY êµ¬ë¬¸ì´ë‚˜ LEFT JOINê³¼ ê°™ì€ ë ˆì½”ë“œ ê±´ìˆ˜ë¥¼ ê°€ì ¸ì˜¤ëŠ”
ê²ƒê³¼ëŠ”ë¬´ê´€í•œ ì‘ì—…ì„ í¬í•¨í•˜ëŠ” ê²ƒì´ë‹¤. ëŒ€ë¶€ë¶„ C0UNT(*) ì¿¼ë¦¬ëŠ” í˜ì´ì§• ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•  ë•Œê°€ë§ì€
ë°, ë§ì€ ê°œë°œìê°€ SELECT ì¿¼ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì¹¼ëŸ¼ì´ ëª…ì‹œëœ ë¶€ë¶„ë§Œ ì‚­ì œí•˜ê³  ê·¸ ë¶€ë¶„ì„ C0UNT(*)
í•¨ìˆ˜ë¡œ ëŒ€ì²´í•´ì„œ ì‚¬ìš©í•˜ê³¤ í•œë‹¤. ê·¸ë˜ì„œ ë‹¨ìˆœíˆ C0UNTC)ë§Œ ì‹¤í–‰í•˜ëŠ” ì¿¼ë¦¬ì„ì—ë„ ORDER BYê°€ í¬í•¨ë¼ ìˆ
ë‹¤ê±°ë‚˜ ë³„ë„ì˜ ì²´í¬ ì¡°ê±´ì„ ê°€ì§€ì§€ë„ ì•ŠëŠ” LEFT ]0INì´ì‹œìš©ëœ ì±„ë¡œ ì‹¤í–‰ë  ë•Œê°€ ë§ë‹¤. C0UNK*) ì¿¼ë¦¬ì—
ì„œ ORDER BY ì ˆì€ ì–´ë–¤ ê²½ìš°ì—ë„ í•„ìš”ì¹˜ ì•Šë‹¤. ê·¸ë¦¬ê³  LEFT JOIN ë˜í•œ ë ˆì½”ë“œ ê±´ìˆ˜ì˜ ë³€í™”ê°€ ì—†ê±°ë‚˜ ì•„
ìš°í„° í…Œì´ë¸”ì—ì„œ ë³„ë„ì˜ ì²´í¬ë¥¼í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ê²½ìš°ì—ëŠ”ëª¨ë‘ ì œê±°í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒì¢‹ë‹¤
```

- ê²°ë¡ ì ìœ¼ë¡œ ë ˆì½”ë“œ countì— ë¶ˆí•„ìš”í•œ ORDER BYë¥¼ ì œê±°í•˜ë¼ëŠ” ì˜ë¯¸
    - JPAë¥¼ ì‚¬ìš©í•˜ì£ ?

### ê¼°ëŒ€ ë¶€ì¥ë‹˜ì´ Count(1)ê³¼ Count(*)ëŠ” ë‹¤ë¥´ëŒ€ìš”.

- ê°™ìŒ

í•˜ì§€ë§Œ COUNT(column1), COUNT(*)ëŠ” ë‹¤ë¥´ë¯€ë¡œ ì¡°ì‹¬íˆ ì‚¬ìš©

- COUNT(column1) ì‚¬ìš© ì‹œ column1 IS NULL ë°ì´í„°ëŠ” ì¹´ìš´íŒ… ë˜ì§€ ì•ŠìŒ

### ì „ì²´ í˜ì´ì§€ ê±´ ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê¸°ëŠ¥ì´ ê¼­ í•„ìš”í•©ë‹ˆê¹Œ?

e.g) 

```sql
SELECT COUNT(*) FROM articles WHERE USE_YN = 'Y' AND DEL_YN= 'N'
```

ì¼ ê²½ìš° WHERE ì ˆ ìˆ˜í–‰ í›„ COUNT(*) ë˜ì–´ì•¼ í•˜ê¸° ë–„ë¬¸ì— ì„±ëŠ¥ ìƒ ë¶ˆë¦¬í•  ìˆ˜ ìˆìŒ

ê°€ëŠ¥í•˜ë‹¤ë©´ ì´ì „, ë‹¤ìŒ ê°™ì€ ê¸°ëŠ¥ìœ¼ë¡œë§Œ í’€ì–´ë‚´ëŠ” ê²ƒë„ ê³ ë ¤ 

### ê¼­ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ í’€ì–´ì•¼ í•©ë‹ˆê¹Œ?

ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ íŠ¹ì • ì¡°ê±´ì— ëŒ€í•œ ì¿¼ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰ ì‹œ ê°€ë…ì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì–ì†Œ

- ìì‹ ì´ ì§°ë”ë¼ë„ ê¸°ì–µì´ ì•ˆë‚ ìˆ˜ë„ ìˆëŠ”ë°, ìƒˆë¡œìš´ ì¸ë ¥ì´ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ë§ˆì£¼í•œë‹¤ë©´?..

E.G)

## ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤: ê³ ê° ì‹ ìš© ë“±ê¸‰ì„ ë‚´ë¶€ ì •ë³´ ê¸°ë°˜ìœ¼ë¡œë§Œ ì—…ë°ì´íŠ¸

> ì‚¬ìš©ìì˜ creditGradeë¥¼ 'D'ë¡œ ë³€ê²½í•˜ë ¤ëŠ” ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
> 

### ğŸ’¡ ë¹„ì¦ˆë‹ˆìŠ¤ ì¡°ê±´ (API ì—†ìŒ)

1. ìµœê·¼ 1ë…„ê°„ **ì·¨ì†Œëœ ì£¼ë¬¸ì´ 3ê±´ ì´ìƒ**
2. **ì „ì²´ ì£¼ë¬¸ ì¤‘ ì·¨ì†Œ ë¹„ìœ¨ì´ 50% ì´ˆê³¼**
3. **ì‹ ê³ ë‹¹í•œ íšŸìˆ˜ê°€ 2íšŒ ì´ìƒ**

e.g DB

```sql
UPDATE users
SET credit_grade = 'D'
WHERE (
    SELECT COUNT(*)
    FROM orders o
    WHERE o.user_id = users.id
      AND o.status = 'cancelled'
      AND o.created_at > NOW() - INTERVAL '1 year'
) >= 3
AND (
    SELECT SUM(CASE WHEN o.status = 'cancelled' THEN o.amount ELSE 0 END)
    FROM orders o
    WHERE o.user_id = users.id
) > (
    SELECT SUM(o.amount)
    FROM orders o
    WHERE o.user_id = users.id
) * 0.5
AND (
    SELECT COUNT(*)
    FROM reports r
    WHERE r.target_user_id = users.id
) >= 2;

```

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì˜ë¯¸ íŒŒì•…ì´ ì–´ë µê³  ê°€ë…ì„±ì´ ì €í•˜ë¨.
- ë˜í•œ ì € UPDATE ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ì„œë¸Œì¿¼ë¦¬ë§Œ 4ê°€ì§€ê°€ ì‚¬ìš©ëìœ¼ë¯€ë¡œ ì„±ëŠ¥ ë©´ì—ì„œë„ ë¶ˆë¦¬í•¨

e.g Application

```sql
public void downgradeCreditGradeForHighRiskUsers() {
    List<User> users = userRepository.findAllWithOrdersAndReports();

    LocalDateTime oneYearAgo = LocalDateTime.now().minusYears(1);

    for (User user : users) {
        List<Order> orders = user.getOrders();

        List<Order> cancelledLastYear = orders.stream()
            .filter(o -> o.getStatus().equals("cancelled"))
            .filter(o -> o.getCreatedAt().isAfter(oneYearAgo))
            .toList();

        if (cancelledLastYear.size() < 3) continue;

        long totalOrders = orders.size();
        long cancelledOrders = orders.stream()
            .filter(o -> o.getStatus().equals("cancelled"))
            .count();

        if (totalOrders == 0 || ((double) cancelledOrders / totalOrders) <= 0.5) continue;

        int reportCount = user.getReports().size();
        if (reportCount < 2) continue;

        user.setCreditGrade("D");
        userRepository.updateUser(user);
    }
}

```

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹œì ì—ì„œ ì´í•´ê°€ ì‰¬ìš°ë¯€ë¡œ ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ì›Œì§

### ì•„í•˜ ê·¸ëŸ¼ ëª¨ë“  ê²ƒì„ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ í’€ì–´ê°€ë©´ ë˜ê² ë„¤ ã…‹ã…‹

```sql
UPDATE departments d,
	(SELECT de.deptjio, C0UNT(*) AS emp_count
	FROM dept_emp de
	GROUP BY de.deptjio) dc
SET d .emp_count=dc.emp_count
WHERE dc.dept_no=d.deptjioï¼›
```

- ì„œë¸Œì¿¼ë¦¬ë¥¼ ì´ìš©í•´ ê° ë¶€ì„œì˜ ì‚¬ì› ìˆ˜ì— ëŒ€í•œ COUNTë¥¼ ì €ì¥í•˜ëŠ” UPDATE ì¿¼ë¦¬

í•´ë‹¹ ì¿¼ë¦¬ì— ëŒ€í•œ ì‘ì—…ì„ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ìˆ˜í–‰í•œë‹¤ë©´?

```sql
public class DepartmentService {

    private final DepartmentRepository departmentRepository;
    private final DeptEmpRepository deptEmpRepository;

    public DepartmentService(DepartmentRepository departmentRepository, DeptEmpRepository deptEmpRepository) {
        this.departmentRepository = departmentRepository;
        this.deptEmpRepository = deptEmpRepository;
    }

    public void updateEmployeeCountForDepartments() {
        // 1. ëª¨ë“  ë¶€ì„œë³„ ì§ì› ìˆ˜ ì§‘ê³„
        Map<String, Long> empCountMap = deptEmpRepository.findDeptEmpCounts(); 
        // ex: { "d001" -> 5, "d002" -> 12 }

        // 2. ë¶€ì„œ ì •ë³´ ì¡°íšŒ í›„ empCount ì—…ë°ì´íŠ¸
        List<Department> departments = departmentRepository.findAll();

        for (Department dept : departments) {
            Long count = empCountMap.getOrDefault(dept.getDeptNo(), 0L);
            dept.setEmpCount(count.intValue());
            departmentRepository.update(dept);
        }
    }
}

```

- ëª¨ë“  ë¶€ì„œì— ëŒ€í•œ ì¹´ìš´íŒ…ì¿¼ë¦¬ë¥¼ ì¼ì¼ì´ ì¡°íšŒí•´ì•¼í•¨
- í•˜ì§€ë§Œ ê¸°ëŠ¥ ë³„ë¡œ ëª…í™•íˆ ë¶„ë¦¬ë¨ (ì§‘ê³„ í›„ ì—…ë°ì´íŠ¸)
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ì›€

### ê²°ë¡ ì ìœ¼ë¡œ.

íŠ¹ì • ê¸°ëŠ¥ì— ëŒ€í•œ ì„±ëŠ¥ì´ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ í’€ì–´ê°€ëŠ” ê²½ìš°ê°€ ì••ë„ì  ìœ ë¦¬í•˜ë‹¤ë©´?

â†’ DBë¡œ í•˜ì‡¼ (í•˜ì§€ë§Œ ê°€ë…ì„± ë¬¸ì œëŠ” íŠ¸ë ˆì´ë“œ ì˜¤í”„)

ë‚˜ë¨¸ì§€ëŠ” ì›¬ë§Œí•˜ë©´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ.
